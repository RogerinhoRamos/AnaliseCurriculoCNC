<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Analisador de Curr√≠culos CNC - Vers√£o Melhorada</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .upload-section {
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .upload-area {
            border: 3px dashed #3498db;
            border-radius: 15px;
            padding: 40px;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .upload-area:hover {
            border-color: #2980b9;
            background: #f8f9fa;
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: #27ae60;
            background: #d5f4e6;
        }

        .upload-icon {
            font-size: 4rem;
            color: #3498db;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.3rem;
            color: #2c3e50;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .upload-subtext {
            color: #7f8c8d;
            font-size: 1rem;
        }

        #fileInput {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2980b9);
            width: 0%;
            transition: width 0.3s ease;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            display: none;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #ecf0f1;
            border-left: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .debug-section {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px;
            border-radius: 10px;
            border-left: 4px solid #3498db;
            display: none;
        }

        .debug-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .debug-content {
            font-family: monospace;
            font-size: 0.9rem;
            background: white;
            padding: 15px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .result-section {
            display: none;
            padding: 40px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            text-align: center;
            border-left: 4px solid #3498db;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2c3e50;
            display: block;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9rem;
            font-weight: 500;
            margin-top: 5px;
        }

        .footer {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 25px 40px;
            text-align: center;
        }

        .copyright {
            font-size: 0.9rem;
            opacity: 0.9;
            margin: 0;
        }

        .developer {
            color: #ecf0f1;
        }

        .developer strong {
            color: #f39c12;
            font-weight: 700;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .upload-section {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Analisador de Curr√≠culos CNC</h1>
            <p>Sistema Melhorado - Extra√ß√£o Precisa para Preparadores e Operadores CNC</p>
        </div>

        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÑ</div>
                <div class="upload-text">Clique ou arraste seus PDFs aqui</div>
                <div class="upload-subtext">Suporte para PDFs individuais ou unificados com m√∫ltiplos candidatos</div>
            </div>
            
            <input type="file" id="fileInput" multiple accept=".pdf" style="display:none;">
            
            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <button class="btn" id="analyzeBtn" onclick="startAnalysis()">üöÄ Iniciar An√°lise Melhorada</button>
        </div>

        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <p>Analisando curr√≠culos com precis√£o melhorada...</p>
        </div>

        <div class="debug-section" id="debugSection">
            <div class="debug-title">üîç Debug da Extra√ß√£o:</div>
            <div class="debug-content" id="debugContent"></div>
        </div>

        <div class="result-section" id="resultSection">
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-number" id="totalCandidates">0</span>
                    <div class="stat-label">Total de Candidatos</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="preparadorCount">0</span>
                    <div class="stat-label">Preparadores CNC</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="operadorCount">0</span>
                    <div class="stat-label">Operadores CNC</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="avgAge">0</span>
                    <div class="stat-label">Idade M√©dia</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="avgExperience">0</span>
                    <div class="stat-label">Anos Experi√™ncia M√©dia</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="categoryACount">0</span>
                    <div class="stat-label">Categoria A (Premium)</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="regionalCount">0%</span>
                    <div class="stat-label">Regi√£o Pr√≥xima (inc. Itupeva)</div>
                </div>
            </div>

            <button class="btn" onclick="generateFinalReport()">üìä Gerar Relat√≥rio Final</button>
        </div>

        <div class="footer">
            <p class="copyright">
                <span class="developer">¬© 2025 ‚Ä¢ Desenvolvido por <strong>Rogerinho Ramos</strong> ‚Ä¢ Vers√£o Melhorada</span>
            </p>
        </div>
    </div>

    <script>
        // Configura√ß√£o do PDF.js
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            console.log('‚úÖ PDF.js configurado com sucesso');
        }

        // Vari√°veis globais
        let analyzedData = [];
        let debugMode = true;

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
        });

        function setupEventListeners() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.addEventListener('click', () => fileInput.click());

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files).filter(file => file.type === 'application/pdf');
                if (files.length) {
                    fileInput.files = e.dataTransfer.files;
                    updateUploadUI(files);
                }
            });

            fileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                updateUploadUI(files);
            });
        }

        function updateUploadUI(files) {
            const uploadText = document.querySelector('.upload-text');
            const analyzeBtn = document.getElementById('analyzeBtn');
            
            if (files.length > 0) {
                uploadText.textContent = `üìÑ ${files.length} arquivo(s) selecionado(s)`;
                analyzeBtn.disabled = false;
            } else {
                uploadText.textContent = 'Clique ou arraste seus PDFs aqui';
                analyzeBtn.disabled = true;
            }
        }

        async function startAnalysis() {
            const files = document.getElementById('fileInput').files;
            if (files.length === 0) {
                showMessage('Por favor, selecione pelo menos um arquivo PDF.', 'error');
                return;
            }

            showLoading();
            debugLog('üöÄ Iniciando an√°lise melhorada...');
            
            try {
                analyzedData = [];
                for (let i = 0; i < files.length; i++) {
                    debugLog(`Processando ${files[i].name} (${i + 1}/${files.length})`);
                    await processFileImproved(files[i], i + 1, files.length);
                }
                
                debugLog(`‚úÖ An√°lise conclu√≠da: ${analyzedData.length} candidatos encontrados`);
                
                if (analyzedData.length > 0) {
                    updateStats();
                    showResults();
                    showMessage(`üéâ An√°lise conclu√≠da! ${analyzedData.length} candidatos processados com precis√£o melhorada.`, 'success');
                } else {
                    showMessage('Nenhum candidato v√°lido foi encontrado. Verifique se os PDFs cont√™m curr√≠culos v√°lidos.', 'error');
                }
                
            } catch (error) {
                debugLog('‚ùå Erro durante an√°lise: ' + error.message);
                showMessage('Erro durante a an√°lise: ' + error.message, 'error');
                console.error('Erro completo:', error);
            }
            
            hideLoading();
        }

        async function processFileImproved(file, index, total) {
            updateProgress(index - 0.5, total);

            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({
                    data: arrayBuffer,
                    cMapUrl: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/cmaps/',
                    cMapPacked: true
                }).promise;
                
                debugLog(`üìÑ PDF carregado: ${pdf.numPages} p√°gina(s)`);
                
                let fullText = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n';
                }

                debugLog(`üìù Texto extra√≠do: ${fullText.length} caracteres`);

                // Detectar e processar candidatos
                const candidates = splitUnifiedPDFImproved(fullText, file.name);
                
                candidates.forEach(candidateData => {
                    if (candidateData.name && candidateData.name.length > 2 && !isInvalidCandidateName(candidateData.name)) {
                        analyzedData.push(candidateData);
                        debugLog(`‚úÖ Candidato adicionado: ${candidateData.name}`);
                    } else {
                        debugLog(`‚ùå Candidato descartado: ${candidateData.name || 'sem nome'}`);
                    }
                });

                updateProgress(index, total);
            } catch (error) {
                debugLog(`‚ùå Erro no processamento: ${error.message}`);
                throw error;
            }
        }

        function splitUnifiedPDFImproved(fullText, filename) {
            debugLog('üîç Iniciando divis√£o melhorada do PDF...');

            // Padr√µes melhorados baseados no PDF de refer√™ncia
            const candidateSeparators = [
                // Padr√£o: n√∫mero. Nome Cand-ID
                /(?=\d+\.\s+[A-Z√Å√ä√Ä√ç√ì√ö][a-z√°√™√†√≠√≥√∫√ß√£√µ\s]+\s+Cand-\d+)/g,
                // Padr√£o: Nome direto seguido de informa√ß√µes
                /(?=[A-Z√Å√ä√Ä√ç√ì√ö][A-Z√Å√ä√Ä√ç√ì√ö√á√É√ï\s]{10,50}\n.*?(?:Brasileiro|anos|Casado|Solteiro|Objetivo))/g,
                // Padr√£o de quebra por se√ß√µes de curr√≠culo
                /(?=Objetivo\s*Profissional|OBJETIVO|Forma√ß√£o\s*Acad√™mica)/g
            ];

            let bestSplit = [fullText];
            
            for (let separator of candidateSeparators) {
                const splits = fullText.split(separator).filter(section => section.trim().length > 100);
                
                if (splits.length > bestSplit.length) {
                    bestSplit = splits;
                    debugLog(`üìä Melhor divis√£o encontrada: ${splits.length} se√ß√µes`);
                }
            }

            debugLog(`üìà Divis√£o final: ${bestSplit.length} se√ß√µes para processar`);

            const candidates = [];
            bestSplit.forEach((section, index) => {
                if (section.trim().length > 50) {
                    const candidateData = extractCandidateInfoImproved(section, `${filename}_candidato_${index + 1}`);
                    
                    if (candidateData.name && candidateData.name.length > 3) {
                        candidates.push(candidateData);
                        debugLog(`‚ú® Candidato processado: ${candidateData.name}`);
                    }
                }
            });

            return candidates;
        }

        function extractCandidateInfoImproved(text, filename) {
            const candidate = {
                name: '',
                age: 0,
                city: '',
                profile: '',
                machineType: '',
                education: '',
                experienceYears: 0,
                candidateId: '',
                filename: filename,
                senaiCourses: 0,
                companies: [],
                score: 0,
                category: '',
                strengths: [],
                fullAddress: ''
            };

            // Padr√µes melhorados baseados nos dados reais
            const patterns = {
                // Nome melhorado - captura nomes compostos
                name: /(?:^|\n)([A-Z√Å√ä√Ä√ç√ì√ö][a-z√°√™√†√≠√≥√∫√ß√£√µ]+(?:\s+[a-z√°√™√†√≠√≥√∫√ß√£√µ]*)*(?:\s+[A-Z√Å√ä√Ä√ç√ì√ö][a-z√°√™√†√≠√≥√∫√ß√£√µ]+)*)\s*(?:\n|‚Ä¢|Brasileiro|Casado|Solteiro|\d+\s*anos|Data|Endere√ßo|Rua|Objetivo)/m,
                
                // ID do candidato
                candidateId: /Cand-(\d+)/i,
                
                // Idade melhorada - m√∫ltiplos formatos
                age: /(\d{1,2})\s*anos|Data.*?nascimento.*?(\d{2})\/(\d{2})\/(\d{4})|(\d{4})\s*[-‚Äì]\s*(Casado|Solteiro)/i,
                
                // Cidades da regi√£o espec√≠fica (+ Itupeva destacada)
                city: /(Jundia√≠|V√°rzea\s+Paulista|Campo\s+Limpo(?:\s+Paulista|\s+Pta)?|Cajamar|Itupeva|Franco\s+da\s+Rocha|S√£o\s+Paulo|Cabre√∫va|Louveira|Itatiba|Sorocaba|Campinas|Santos|Indaiatuba)/i,
                
                // Endere√ßo completo
                address: /(?:Endere√ßo|Rua|Avenida|Av\.)[\s:]*([^,\n]+(?:,\s*[^,\n]+)*)/i,
                
                // Perfil profissional melhorado
                profile: /(Preparador|Operador|PREPARADOR|OPERADOR|Prep\.?\s*Op\.?\s*CNC|Multifuncional|Setup|Preset)/gi,
                
                // Tipos de m√°quina
                machines: /(Torno\s+CNC|Centro\s+de\s+Usinagem|Torno\s+Vertical|Torno\s+Horizontal|centro\s+de\s+usinagem|torno\s+cnc|CNC|Ret√≠fica|Fresadora)/gi,
                
                // Educa√ß√£o
                education: /(Ensino\s+M√©dio|Superior|T√©cnico|Gradua√ß√£o|Engenharia|Tecn√≥logo|Bacharel)/i,
                
                // Experi√™ncia profissional melhorada
                experience: /(\d{4})\s*[-‚Äì]\s*(\d{4}|atual|presente|\w+)|Per√≠odo.*?(\d{1,2})\/(\d{4}).*?(\d{1,2})\/(\d{4})/g,
                
                // Cursos SENAI
                senaiCourse: /(SENAI|Senai).*?(Programa√ß√£o|Opera√ß√£o|Torno|Centro|Usinagem|CNC|Mec√¢nica)/gi,
                
                // Empresas relevantes
                companies: /(ThyssenKrupp|SKF|Continental|Dana|Knorr|Sifco|Dexco|Klabin|Joyson|Alpino|Procter|Gamble|Mark\s+Ferramentas)/gi
            };

            // Extrair nome
            const nameMatch = text.match(patterns.name);
            if (nameMatch) {
                const cleanName = nameMatch[1].trim().replace(/[‚Ä¢\n\r\t]/g, ' ').replace(/\s+/g, ' ');
                if (isValidName(cleanName)) {
                    candidate.name = normalizeName(cleanName);
                }
            }

            // Extrair ID do candidato
            const idMatch = text.match(patterns.candidateId);
            if (idMatch) {
                candidate.candidateId = idMatch[1];
            }

            // Extrair idade
            const ageMatch = text.match(patterns.age);
            if (ageMatch) {
                if (ageMatch[1]) {
                    const age = parseInt(ageMatch[1]);
                    if (age >= 16 && age <= 80) {
                        candidate.age = age;
                    }
                } else if (ageMatch[4]) {
                    const birthYear = parseInt(ageMatch[4]);
                    if (birthYear > 1940 && birthYear < 2010) {
                        candidate.age = 2025 - birthYear;
                    }
                }
            }

            // Extrair cidade
            const cityMatch = text.match(patterns.city);
            if (cityMatch) {
                candidate.city = normalizeCity(cityMatch[1]);
            }

            // Determinar perfil
            const profileMatches = text.match(patterns.profile) || [];
            candidate.profile = determineProfile(profileMatches, text);

            // Determinar tipo de m√°quina
            const machineMatches = text.match(patterns.machines) || [];
            candidate.machineType = determineMachineType(machineMatches, text);

            // Extrair educa√ß√£o
            const educationMatch = text.match(patterns.education);
            if (educationMatch) {
                candidate.education = normalizeEducation(educationMatch[1]);
            }

            // Contar cursos SENAI
            const senaiMatches = text.match(patterns.senaiCourse) || [];
            candidate.senaiCourses = senaiMatches.length;

            // Extrair empresas
            const companyMatches = text.match(patterns.companies) || [];
            candidate.companies = [...new Set(companyMatches)];

            // Calcular experi√™ncia
            candidate.experienceYears = calculateExperience(text, patterns.experience);

            // Calcular score e categoria
            candidate.score = calculateCandidateScore(candidate);
            candidate.category = categorizeCandidateByScore(candidate);

            return candidate;
        }

        // Fun√ß√µes auxiliares (mantidas do original mas com melhorias)
        function isValidName(name) {
            const invalidNames = [
                'brasileiro', 'brasileira', 'casado', 'casada', 'solteiro', 'solteira',
                'experi√™ncia', 'profissional', 'forma√ß√£o', 'acad√™mica', 'cursos',
                'complementares', 'objetivo', 'resumo', 'qualifica√ß√µes', 'informa√ß√µes'
            ];
            
            const nameLower = name.toLowerCase();
            for (let invalid of invalidNames) {
                if (nameLower.includes(invalid)) return false;
            }
            
            const words = name.trim().split(/\s+/);
            return words.length >= 2 && words.every(word => word.length >= 2);
        }

        function isInvalidCandidateName(name) {
            const invalidPatterns = [
                /^(sp|s√£o paulo|brasileiro|experi√™ncia|cursos|forma√ß√£o|objetivo|resumo)$/i,
                /^[a-z\s]{1,5}$/i,
                /^\d+\.?\s*$/,
            ];
            
            return invalidPatterns.some(pattern => pattern.test(name.trim()));
        }

        function normalizeName(name) {
            return name.toLowerCase().replace(/\b\w/g, l => l.toUpperCase())
                      .replace(/\s+/g, ' ').trim()
                      .split(' ').slice(0, 4).join(' ');
        }

        function normalizeCity(city) {
            const cityNormalizations = {
                'campo limpo': 'Campo Limpo Paulista',
                'campo limpo paulista': 'Campo Limpo Paulista',
                'campo limpo pta': 'Campo Limpo Paulista',
                'v√°rzea paulista': 'V√°rzea Paulista',
                'varzea paulista': 'V√°rzea Paulista',
                'itupeva': 'Itupeva',
                'jundiai': 'Jundia√≠',
                'jundia√≠': 'Jundia√≠',
                'cajamar': 'Cajamar',
                'franco da rocha': 'Franco da Rocha',
                'sao paulo': 'S√£o Paulo',
                's√£o paulo': 'S√£o Paulo'
            };
            
            const cityLower = city.toLowerCase().trim();
            return cityNormalizations[cityLower] || city.trim();
        }

        function determineProfile(profileMatches, text) {
            const preparadorCount = profileMatches.filter(p => 
                p.toLowerCase().includes('preparador') || 
                p.toLowerCase().includes('prep') ||
                p.toLowerCase().includes('setup')
            ).length;
            
            const operadorCount = profileMatches.filter(p => 
                p.toLowerCase().includes('operador') && !p.toLowerCase().includes('preparador')
            ).length;
            
            if (preparadorCount > 0 && operadorCount > 0) return 'mixed';
            else if (preparadorCount > operadorCount) return 'preparador';
            else if (operadorCount > 0) return 'operador';
            else return 'operador';
        }

        function determineMachineType(machineMatches, text) {
            const tornoCount = machineMatches.filter(m => 
                m.toLowerCase().includes('torno')
            ).length;
            
            const centroCount = machineMatches.filter(m => 
                m.toLowerCase().includes('centro') || m.toLowerCase().includes('usinagem')
            ).length;

            if (tornoCount > 0 && centroCount > 0) return 'ambos';
            else if (tornoCount > centroCount && centroCount === 0) return 'torno';
            else if (centroCount > tornoCount && tornoCount === 0) return 'centro';
            else if (tornoCount > 0 || centroCount > 0) return 'ambos';
            else return 'nao_especificado';
        }

        function normalizeEducation(education) {
            const eduLower = education.toLowerCase();
            if (eduLower.includes('superior') || eduLower.includes('engenharia')) return 'Superior';
            else if (eduLower.includes('t√©cnico')) return 'T√©cnico';
            else return 'Ensino M√©dio';
        }

        function calculateExperience(text, experiencePattern) {
            let totalExperience = 0;
            let experienceMatches = [];
            let match;
            
            const experienceRegex = new RegExp(experiencePattern);
            while ((match = experienceRegex.exec(text)) !== null) {
                experienceMatches.push(match);
            }

            experienceMatches.forEach(match => {
                let startYear, endYear;
                
                if (match[1] && match[2]) {
                    startYear = parseInt(match[1]);
                    endYear = match[2] === 'atual' || match[2].toLowerCase().includes('presente') ? 2025 : parseInt(match[2]);
                } else if (match[3] && match[4] && match[5] && match[6]) {
                    startYear = parseInt(match[4]);
                    endYear = parseInt(match[6]);
                }
                
                if (startYear && endYear && endYear >= startYear && startYear > 1990 && startYear < 2025) {
                    const years = Math.min(endYear - startYear, 25);
                    if (years > 0) {
                        totalExperience += years;
                    }
                }
            });

            return Math.min(totalExperience, 30);
        }

        function calculateCandidateScore(candidate) {
            let score = 0;
            
            // Experi√™ncia (40%)
            if (candidate.experienceYears >= 20) score += 40;
            else if (candidate.experienceYears >= 15) score += 35;
            else if (candidate.experienceYears >= 10) score += 30;
            else if (candidate.experienceYears >= 5) score += 20;
            else if (candidate.experienceYears >= 2) score += 10;
            
            // Perfil (20%)
            if (candidate.profile === 'preparador') score += 20;
            else if (candidate.profile === 'mixed') score += 18;
            else if (candidate.profile === 'operador') score += 15;
            
            // Versatilidade (15%)
            if (candidate.machineType === 'ambos') {
                score += 15;
                candidate.strengths.push('Vers√°til');
            } else if (candidate.machineType === 'centro') {
                score += 10;
            } else if (candidate.machineType === 'torno') {
                score += 8;
            }
            
            // Educa√ß√£o (15%)
            if (candidate.education === 'Superior') {
                score += 15;
                candidate.strengths.push('Forma√ß√£o Superior');
            } else if (candidate.education === 'T√©cnico') {
                score += 10;
                candidate.strengths.push('Forma√ß√£o T√©cnica');
            } else if (candidate.education === 'Ensino M√©dio') {
                score += 5;
            }
            
            // Bonifica√ß√µes (10%)
            if (candidate.senaiCourses >= 3) score += 5;
            if (candidate.companies.length >= 3) score += 3;
            if (candidate.age >= 25 && candidate.age <= 40) score += 2;
            
            return Math.round(score);
        }

        function categorizeCandidateByScore(candidate) {
            if (candidate.score >= 80) return 'A';
            else if (candidate.score >= 65) return 'B';
            else if (candidate.score >= 50) return 'C';
            else return 'D';
        }

        function updateStats() {
            const total = analyzedData.length;
            const preparadores = analyzedData.filter(c => c.profile === 'preparador').length;
            const operadores = analyzedData.filter(c => c.profile === 'operador').length;
            const categoryA = analyzedData.filter(c => c.category === 'A').length;
            
            const avgAge = total > 0 ? Math.round(analyzedData.reduce((sum, c) => sum + c.age, 0) / total) : 0;
            const avgExp = total > 0 ? Math.round(analyzedData.reduce((sum, c) => sum + c.experienceYears, 0) / total) : 0;

            // Cidades principais da regi√£o (incluindo Itupeva)
            const regionalCities = ['V√°rzea Paulista', 'Jundia√≠', 'Campo Limpo Paulista', 'Itupeva', 'Cajamar'];
            const regionalCount = analyzedData.filter(c => regionalCities.includes(c.city)).length;
            const regionalPercentage = total > 0 ? Math.round((regionalCount / total) * 100) : 0;

            document.getElementById('totalCandidates').textContent = total;
            document.getElementById('preparadorCount').textContent = preparadores;
            document.getElementById('operadorCount').textContent = operadores;
            document.getElementById('avgAge').textContent = avgAge || 0;
            document.getElementById('avgExperience').textContent = avgExp || 0;
            document.getElementById('categoryACount').textContent = categoryA;
            document.getElementById('regionalCount').textContent = `${regionalPercentage}%`;
            
            // Debug das cidades encontradas
            const cityCounts = {};
            analyzedData.forEach(c => {
                const city = c.city || 'N√£o informado';
                cityCounts[city] = (cityCounts[city] || 0) + 1;
            });
            debugLog(`üèôÔ∏è Distribui√ß√£o de cidades: ${JSON.stringify(cityCounts, null, 2)}`);
        }

        function generateFinalReport() {
            debugLog('üìä Gerando relat√≥rio final...');
            
            // Aqui vamos criar o relat√≥rio final estilo "paste-2.txt"
            const reportWindow = window.open('', '_blank');
            const reportHTML = createFinalReport();
            
            reportWindow.document.write(reportHTML);
            reportWindow.document.close();
            
            showMessage('‚úÖ Relat√≥rio final gerado com sucesso! Verifique a nova aba.', 'success');
        }

        function createFinalReport() {
            const categoryA = analyzedData.filter(c => c.category === 'A').sort((a, b) => b.score - a.score);
            const avgAge = Math.round(analyzedData.reduce((sum, c) => sum + c.age, 0) / analyzedData.length);
            const avgExp = Math.round(analyzedData.reduce((sum, c) => sum + c.experienceYears, 0) / analyzedData.length);
            const senaiPercentage = Math.round((analyzedData.filter(c => c.senaiCourses > 0).length / analyzedData.length) * 100);

            return `<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Relat√≥rio de An√°lise - Candidatos CNC</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .header h1 { color: #2c3e50; font-size: 2.5em; margin-bottom: 10px; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .stat-number { font-size: 3em; font-weight: bold; color: #3498db; margin-bottom: 10px; }
        .stat-label { color: #7f8c8d; font-size: 1.1em; }
        .recommendations {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        .recommendations h2 { color: #2c3e50; font-size: 2em; margin-bottom: 20px; text-align: center; }
        .highlight {
            background: linear-gradient(120deg, #a8edea 0%, #fed6e3 100%);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #e74c3c;
        }
        .top-candidates {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        .candidate-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: linear-gradient(90deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }
        .candidate-name { font-weight: bold; color: #2c3e50; font-size: 1.1em; }
        .candidate-details { color: #7f8c8d; font-size: 0.9em; margin-top: 5px; }
        .candidate-score {
            background: #3498db;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
        }
        .footer {
            text-align: center;
            padding: 20px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Relat√≥rio de An√°lise - Candidatos CNC</h1>
            <p>An√°lise Automatizada Melhorada - Preparadores e Operadores CNC</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">${analyzedData.length}</div>
                <div class="stat-label">Total de Candidatos</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${avgAge}</div>
                <div class="stat-label">Idade M√©dia (anos)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${avgExp}</div>
                <div class="stat-label">Experi√™ncia M√©dia (anos)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${senaiPercentage}%</div>
                <div class="stat-label">Com Forma√ß√£o SENAI</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${Math.round((analyzedData.filter(c => ['V√°rzea Paulista', 'Jundia√≠', 'Campo Limpo Paulista', 'Itupeva', 'Cajamar'].includes(c.city)).length / analyzedData.length) * 100)}%</div>
                <div class="stat-label">Regi√£o Pr√≥xima (inc. Itupeva)</div>
            </div>
        </div>

        <div class="top-candidates">
            <h2>üèÜ TOP 5 - Candidatos Premium (Categoria A)</h2>
            ${categoryA.slice(0, 5).map((c, i) => `
                <div class="candidate-item">
                    <div>
                        <div class="candidate-name">${c.name}</div>
                        <div class="candidate-details">${c.age} anos ‚Ä¢ ${c.city || 'N/I'} ‚Ä¢ ${c.education} ‚Ä¢ ${c.experienceYears} anos exp.</div>
                    </div>
                    <div class="candidate-score">${c.score}</div>
                </div>
            `).join('')}
        </div>

        <div class="recommendations">
            <h2>üéØ Recomenda√ß√µes Estrat√©gicas</h2>
            
            <div class="highlight">
                <h3>üíé CONTRATA√á√ÉO PRIORIT√ÅRIA IMEDIATA</h3>
                <p><strong>Top 3 Candidatos:</strong></p>
                <ul>
                    ${categoryA.slice(0, 3).map(c => `<li><strong>${c.name}</strong> - Score ${c.score} - ${c.experienceYears} anos de experi√™ncia</li>`).join('')}
                </ul>
            </div>

            <p><strong>üìä DADOS ESTRAT√âGICOS:</strong></p>
            <ul>
                <li>${analyzedData.filter(c => c.experienceYears >= 20).length} candidatos t√™m 20+ anos de experi√™ncia (Seniores)</li>
                <li>${analyzedData.filter(c => c.profile === 'mixed').length} candidatos s√£o multifuncionais (Versatilidade)</li>
                <li>${analyzedData.filter(c => c.machineType === 'ambos').length} candidatos trabalham com ambas m√°quinas</li>
                <li>${Math.round((analyzedData.filter(c => ['V√°rzea Paulista', 'Jundia√≠', 'Campo Limpo Paulista', 'Itupeva', 'Cajamar'].includes(c.city)).length / analyzedData.length) * 100)}% residem na regi√£o pr√≥xima (Log√≠stica favor√°vel)</li>
                <li>${Math.round((analyzedData.filter(c => c.education === 'Superior').length / analyzedData.length) * 100)}% t√™m forma√ß√£o superior</li>
            </ul>

            <p><strong>üåç CONCENTRA√á√ÉO GEOGR√ÅFICA:</strong></p>
            <ul>
                ${(() => {
                    const cityCounts = {};
                    analyzedData.forEach(c => {
                        const city = c.city || 'N√£o informado';
                        cityCounts[city] = (cityCounts[city] || 0) + 1;
                    });
                    
                    // Ordenar cidades por quantidade
                    const sortedCities = Object.entries(cityCounts)
                        .sort(([,a], [,b]) => b - a)
                        .slice(0, 6); // Top 6 cidades
                    
                    return sortedCities.map(([city, count]) => 
                        `<li><strong>${city}:</strong> ${count} candidatos (${Math.round((count/analyzedData.length)*100)}%)</li>`
                    ).join('');
                })()}
                ${Object.keys(analyzedData.reduce((acc, c) => { 
                    const city = c.city || 'N√£o informado'; 
                    acc[city] = true; 
                    return acc; 
                }, {})).length > 6 ? '<li><strong>Outras cidades:</strong> Distribui√ß√£o diversificada</li>' : ''}
            </ul>
        </div>

        <div class="footer">
            <p>üìÖ Relat√≥rio gerado automaticamente em maio de 2025 ‚Ä¢ Base: ${analyzedData.length} curr√≠culos analisados</p>
            <p>¬© 2025 ‚Ä¢ Desenvolvido por <strong>Rogerinho Ramos</strong> ‚Ä¢ Sistema Melhorado</p>
        </div>
    </div>
</body>
</html>`;
        }

        function debugLog(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `üîç ${timestamp}: ${message}`;
            console.log(logMessage, data || '');
            
            const debugContent = document.getElementById('debugContent');
            if (debugContent) {
                debugContent.textContent += logMessage + '\n';
                debugContent.scrollTop = debugContent.scrollHeight;
            }
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('debugSection').style.display = 'block';
            document.getElementById('analyzeBtn').disabled = true;
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('analyzeBtn').disabled = false;
        }

        function showResults() {
            document.getElementById('resultSection').style.display = 'block';
        }

        function updateProgress(current, total) {
            const progress = (current / total) * 100;
            const progressFill = document.getElementById('progressFill');
            if (progressFill) {
                progressFill.style.width = `${progress}%`;
            }
        }

        function showMessage(message, type = 'info') {
            const existingMessages = document.querySelectorAll('.error-message, .success-message');
            existingMessages.forEach(msg => msg.remove());
            
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
            messageDiv.textContent = message;
            
            const uploadSection = document.querySelector('.upload-section');
            uploadSection.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 5000);
        }
    </script>
</body>
</html>
